<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin - IGNICAR TOYS</title>
<style>
body{font-family:sans-serif;margin:20px;background:#f1f5f9;color:#0f172a}
h1,h2{margin-bottom:12px}
input,button,select{padding:6px;margin:4px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#334155;color:white}
.success{color:green}
.error{color:red}
.hidden{display:none}
</style>
</head>
<body>

<h1>üîê Panel Admin - IGNICAR TOYS</h1>

<!-- LOGIN -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Usuario"><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button onclick="login()">Ingresar</button>
  <p id="loginMsg"></p>
</div>

<!-- PANEL ADMIN -->
<div id="adminDiv" class="hidden">

  <button onclick="logout()">Cerrar sesi√≥n</button>

  <h2>Productos</h2>
  <table>
    <thead>
      <tr>
        <th>Activo</th>
        <th>Nombre</th>
        <th>Categor√≠a</th>
        <th>Precio</th>
        <th>Descuento (%)</th>
        <th>Stock</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody id="productsTable"></tbody>
  </table>

  <h2>Crear Producto Nuevo</h2>
  <div>
    <input type="text" id="newName" placeholder="Nombre">
    <input type="text" id="newCategory" placeholder="Categor√≠a">
    <input type="text" id="newImage" placeholder="URL Imagen">
    <input type="number" id="newPrice" placeholder="Precio" min="0">
    <input type="number" id="newDiscount" placeholder="Descuento %" min="0" max="100">
    <input type="number" id="newStock" placeholder="Stock" min="0">
    <label>Activo <input type="checkbox" id="newActive" checked></label>
    <button onclick="createProduct()">Crear</button>
    <p id="createMsg"></p>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMHt8Gu7O5bGWp7TbzS_fNWnyC2TaIfiU",
  authDomain: "ignicar-toys.firebaseapp.com",
  projectId: "ignicar-toys",
  storageBucket: "ignicar-toys.firebasestorage.app",
  messagingSenderId: "166759344812",
  appId: "1:166759344812:web:5722c60005bde18e568d09"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;

// LOGIN
async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  if(!username || !password){ msg.innerText="Completa ambos campos"; return; }

  const q = query(collection(db,"admins"), where("username","==",username));
  const snap = await getDocs(q);

  if(snap.empty){ msg.innerText="Usuario no encontrado"; return; }

  const user = snap.docs[0].data();
  if(user.password !== password){ msg.innerText="Contrase√±a incorrecta"; return; }

  currentUser = user;
  document.getElementById("loginDiv").classList.add("hidden");
  document.getElementById("adminDiv").classList.remove("hidden");

  loadProducts();
}

// LOGOUT
function logout(){
  currentUser = null;
  document.getElementById("loginDiv").classList.remove("hidden");
  document.getElementById("adminDiv").classList.add("hidden");
  document.getElementById("loginMsg").innerText="";
}

// CARGAR PRODUCTOS
function loadProducts(){
  const table = document.getElementById("productsTable");

  onSnapshot(collection(db,"products"), snapshot => {
    table.innerHTML = "";

    snapshot.forEach(docSnap => {
      const p = docSnap.data();
      const id = docSnap.id;

      if(p.name==="init") return;

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><input type="checkbox" class="activeBox" data-id="${id}" ${p.active?"checked":""} ${currentUser.role==="stock"?"":"disabled"}></td>
        <td><input type="text" class="nameInput" value="${p.name}" data-id="${id}" ${currentUser.role==="editor"||currentUser.role==="superadmin"?"":"disabled"}></td>
        <td><input type="text" class="catInput" value="${p.category}" data-id="${id}" ${currentUser.role==="superadmin"?"":"disabled"}></td>
        <td><input type="number" class="priceInput" value="${p.price}" data-id="${id}" ${currentUser.role==="editor"||currentUser.role==="superadmin"?"":"disabled"}></td>
        <td><input type="number" class="discInput" value="${p.discount||0}" data-id="${id}" ${currentUser.role==="editor"||currentUser.role==="superadmin"?"":"disabled"}></td>
        <td><input type="number" class="stockInput" value="${p.stock}" data-id="${id}" ${currentUser.role==="stock"||currentUser.role==="superadmin"?"":"disabled"}></td>
        <td><button data-id="${id}">Guardar</button></td>
      `;

      table.appendChild(tr);
    });

    bindEvents();
  });
}

// GUARDAR CAMBIOS
function bindEvents(){
  document.querySelectorAll("#productsTable button").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id;
      const docRef = doc(db,"products",id);

      const active = document.querySelector(`.activeBox[data-id="${id}"]`).checked;
      const name = document.querySelector(`.nameInput[data-id="${id}"]`).value.trim();
      const category = document.querySelector(`.catInput[data-id="${id}"]`).value.trim();
      const price = parseFloat(document.querySelector(`.priceInput[data-id="${id}"]`).value);
      const discount = parseInt(document.querySelector(`.discInput[data-id="${id}"]`).value);
      const stock = parseInt(document.querySelector(`.stockInput[data-id="${id}"]`).value);

      await updateDoc(docRef,{
        active, name, category, price, discount, stock
      });

      alert("‚úÖ Producto actualizado");
    };
  });
}

// CREAR PRODUCTO NUEVO
async function createProduct(){
  const name = document.getElementById("newName").value.trim();
  const category = document.getElementById("newCategory").value.trim();
  const image = document.getElementById("newImage").value.trim();
  const price = parseFloat(document.getElementById("newPrice").value);
  const discount = parseInt(document.getElementById("newDiscount").value) || 0;
  const stock = parseInt(document.getElementById("newStock").value);
  const active = document.getElementById("newActive").checked;
  const msg = document.getElementById("createMsg");

  if(!name||!category||!image||isNaN(price)||isNaN(stock)){ msg.innerText="Completa todos los campos"; return; }

  await addDoc(collection(db,"products"),{
    name, category, image, price, discount, stock, active
  });

  msg.innerText = "‚úÖ Producto creado";
  setTimeout(()=>msg.innerText="",2000);
}

</script>
</body>
</html>
