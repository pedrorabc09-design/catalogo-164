<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - IGNICAR TOYS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;padding:20px;background:#f1f5f9}
    h1{text-align:center;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;vertical-align:middle}
    th{background:#334155;color:white}
    img.product-img{width:80px;height:50px;object-fit:contain}
    input,select{width:100%;box-sizing:border-box;padding:4px}
    button{padding:6px 10px;margin:2px;cursor:pointer}
    #loginForm{max-width:300px;margin:50px auto;padding:20px;background:white;border-radius:10px;text-align:center}
    #loginForm input{width:90%;margin:6px 0}
    #newProductBtn{margin-bottom:10px;padding:8px 12px;background:#0ea5e9;color:white;border:none;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>

<div id="loginForm">
  <h2>ðŸ”’ Admin Login</h2>
  <input type="text" id="username" placeholder="Usuario"><br>
  <input type="password" id="password" placeholder="ContraseÃ±a"><br>
  <button onclick="login()">Ingresar</button>
  <p id="loginError" style="color:red"></p>
</div>

<div id="adminPanel" style="display:none">
  <h1>ðŸ“¦ Panel Admin</h1>
  <button id="newProductBtn" onclick="createNewProduct()">âž• Crear Nuevo Producto</button>
  <button id="saveAllBtn" style="margin:15px 0;padding:8px 14px;">
  ðŸ’¾ Guardar todos los cambios
</button>

  <table>
    <thead>
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>CÃ³digo</th>
        <th>CategorÃ­a</th>
        <th>Precio</th>
        <th>Precio Desc.</th>
        <th>Stock</th>
        <th>Activo</th>
        <th>Guardar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="productsTable"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc,
  addDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// ðŸ”¥ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMHt8Gu7O5bGWp7TbzS_fNWnyC2TaIfiU",
  authDomain: "ignicar-toys.firebaseapp.com",
  projectId: "ignicar-toys",
  storageBucket: "ignicar-toys.firebasestorage.app",
  messagingSenderId: "166759344812",
  appId: "1:166759344812:web:5722c60005bde18e568d09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const loginForm = document.getElementById("loginForm");
const adminPanel = document.getElementById("adminPanel");
const productsTable = document.getElementById("productsTable");

// Simple login
const ADMIN_USER = "admin";
const ADMIN_PASS = "1234";

window.login = ()=>{
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const error = document.getElementById("loginError");

  if(u===ADMIN_USER && p===ADMIN_PASS){
    loginForm.style.display="none";
    adminPanel.style.display="block";
    listenProducts();
  }else{
    error.innerText="Usuario o contraseÃ±a incorrectos";
  }
}

// Escucha productos en tiempo real
let categoriesSet = new Set();

function listenProducts(){
  onSnapshot(collection(db,"products"), snapshot => {
    productsTable.innerHTML = "";
    categoriesSet.clear();

    const products = [];

    // âœ… PASO 1: recorrer snapshot SOLO para datos
    snapshot.forEach(docSnap => {
      const p = docSnap.data();
      if(!p.name || p.name === "init") return;

      if(p.category) categoriesSet.add(p.category);

      products.push({
        id: docSnap.id,
        ...p
      });
    });

    const categoriesHTML = Array.from(categoriesSet)
      .map(cat => `<option value="${cat}">${cat}</option>`)
      .join("");

    // âœ… PASO 2: renderizar filas ya con TODAS las categorÃ­as
    products.forEach(p => {
      const tr = document.createElement("tr");
      tr.dataset.id = p.id;
      tr.dataset.changed = "false";


      tr.innerHTML = `
        <td>${p.image ? `<img class="product-img" src="${p.image}">` : ""}</td>

        <td style="white-space:normal;min-width:220px">
          ${p.name}
        </td>

        <td>
          <input type="text" value="${p.code || p.id}" class="codeInput">
        </td>

        <td>
          <select class="categorySelect">
            ${categoriesHTML.replace(
              `value="${p.category}"`,
              `value="${p.category}" selected`
            )}
          </select>
          <input type="text" placeholder="Nueva categorÃ­a" class="newCategoryInput">
        </td>

        <td><input type="number" value="${p.price || 0}" class="priceInput"></td>

        <td><input type="number" value="${p.discountPrice || 0}" class="discountInput"></td>

        <td><input type="number" value="${p.stock || 0}" class="stockInput"></td>

        <td>
          <input type="checkbox" class="activeInput" ${p.active ? "checked" : ""}>
        </td>

        <td>
          <button class="saveBtn" data-id="${p.id}">ðŸ’¾ Guardar</button>
        </td>
        <td>
        <button class="deleteBtn" data-id="${p.id}" style="background:#dc2626;color:white">ðŸ—‘ Eliminar</button>
        </td>

      `;

      productsTable.appendChild(tr);

tr.querySelectorAll("input, select").forEach(el => {
  el.onchange = () => {
    tr.dataset.changed = "true";
    tr.style.background = "#fff7ed";
  };
});
    });
    bindEvents();
  });
}

 async function saveAllProducts(){
  const rows = document.querySelectorAll("tr[data-changed='true']");

  if(rows.length === 0){
    alert("â„¹ï¸ No hay cambios para guardar");
    return;
  }

  if(!confirm(`Â¿Guardar cambios en ${rows.length} productos?`)) return;

  for(const tr of rows){
    const id = tr.dataset.id;

    const code = tr.querySelector(".codeInput").value;
    let category = tr.querySelector(".categorySelect").value;
    const newCat = tr.querySelector(".newCategoryInput").value;
    if(newCat) category = newCat;

    const price = parseFloat(tr.querySelector(".priceInput").value)||0;
    const discountPrice = parseFloat(tr.querySelector(".discountInput").value)||0;
    const stock = parseInt(tr.querySelector(".stockInput").value)||0;
    const active = tr.querySelector(".activeInput").checked;

    const discountPercent = price > 0
      ? Math.round(((price - discountPrice) / price) * 100)
      : 0;

    await updateDoc(doc(db,"products",id),{
      code,
      category,
      price,
      discountPrice,
      discountPercent,
      stock,
      active
    });

    tr.dataset.changed = "false";
    tr.style.background = "";
  }

  alert("âœ… Cambios masivos guardados correctamente");
}


  
// Bind botones y inputs
function bindEvents(){
  document.querySelectorAll(".saveBtn").forEach(btn=>{
    btn.onclick=async ()=>{
      const id = btn.dataset.id;
      const tr = btn.closest("tr");

      const code = tr.querySelector(".codeInput").value;
      let category = tr.querySelector(".categorySelect").value;
      const newCat = tr.querySelector(".newCategoryInput").value;
      if(newCat) category = newCat;

      const price = parseFloat(tr.querySelector(".priceInput").value)||0;
      const discountPrice = parseFloat(tr.querySelector(".discountInput").value)||0;
      const stock = parseInt(tr.querySelector(".stockInput").value)||0;
      const active = tr.querySelector(".activeInput").checked;

      // calcular descuento %
      const discountPercent = price>0?Math.round(100*(price-discountPrice)/price):0;

      await updateDoc(doc(db,"products",id),{
        code, category, price, discountPrice, stock, active, discountPercent
      });

      alert("âœ… Producto actualizado");
    }
  });

  document.querySelectorAll(".deleteBtn").forEach(btn=>{
  btn.onclick = async ()=>{
    const id = btn.dataset.id;

    if(!confirm("âš ï¸ Â¿Eliminar este producto definitivamente?")) return;

    await deleteDoc(doc(db,"products",id));

    alert("ðŸ—‘ Producto eliminado correctamente");
  };
});

}

document.getElementById("saveAllBtn").onclick = saveAllProducts;
window.saveAllProducts = saveAllProducts;

  

// Crear nuevo producto
window.createNewProduct = async () => {
  const name = prompt("Nombre del producto:");
  if (!name) {
    alert("Nombre obligatorio");
    return;
  }

  const category = prompt("CategorÃ­a del producto:") || "";
  const price = parseFloat(prompt("Precio:")) || 0;
  const discountPrice = parseFloat(prompt("Precio con descuento:")) || 0;
  const stock = parseInt(prompt("Stock:")) || 0;
  const image = prompt(
    "URL de la imagen (ej: https://pedrorabc09-design.github.io/catalogo-164/imagenes/archivo.png)"
  ) || "";

  const discountPercent =
    price > 0
      ? Math.round(((price - discountPrice) / price) * 100)
      : 0;

  await addDoc(collection(db, "products"), {
    name,
    code: "ID" + Date.now(),
    category,
    price,
    discountPrice,
    discountPercent,
    stock,
    active: true, // ðŸ‘ˆ por defecto visible
    image
  });

  alert("âœ… Producto creado correctamente");
};

</script>

</body>
</html>
