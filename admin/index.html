<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - IGNICAR TOYS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;padding:20px;background:#f0f2f5;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th, td{border:1px solid #ccc;padding:8px;text-align:left;vertical-align:middle;}
    input[type="text"], input[type="number"]{width:100%;box-sizing:border-box;}
    button{padding:6px 12px;margin:2px;cursor:pointer;}
    .active-checkbox{text-align:center;}
    img.preview{width:80px;height:80px;object-fit:contain;}
  </style>
</head>
<body>

<h1>ðŸ“¦ Panel Admin - IGNICAR TOYS</h1>

<button onclick="createProduct()">âž• Crear Producto Nuevo</button>

<table>
  <thead>
    <tr>
      <th>Nombre</th>
      <th>CÃ³digo</th>
      <th>CategorÃ­a</th>
      <th>Precio S/</th>
      <th>Precio con Descuento S/</th>
      <th>Stock</th>
      <th>Activo</th>
      <th>Imagen</th>
      <th>AcciÃ³n</th>
    </tr>
  </thead>
  <tbody id="productsTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

// ðŸ”¥ ConfiguraciÃ³n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAMHt8Gu7O5bGWp7TbzS_fNWnyC2TaIfiU",
  authDomain: "ignicar-toys.firebaseapp.com",
  projectId: "ignicar-toys",
  storageBucket: "ignicar-toys.firebasestorage.app",
  messagingSenderId: "166759344812",
  appId: "1:166759344812:web:5722c60005bde18e568d09"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const table = document.getElementById("productsTable");

// Escucha productos en tiempo real
onSnapshot(collection(db, "products"), snapshot => {
  table.innerHTML = "";
  snapshot.forEach(docSnap => {
    const p = docSnap.data();
    const id = docSnap.id;
    if (p.name === "init") return;

    const discountPrice = p.discountPrice || p.price || 0;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="text" value="${p.name}" data-id="${id}" class="nameInput"></td>
      <td><input type="text" value="${p.code||id}" data-id="${id}" class="codeInput"></td>
      <td><input type="text" value="${p.category}" data-id="${id}" class="categoryInput"></td>
      <td><input type="number" min="0" value="${p.price}" data-id="${id}" class="priceInput"></td>
      <td><input type="number" min="0" value="${discountPrice}" data-id="${id}" class="discountPriceInput"></td>
      <td><input type="number" min="0" value="${p.stock}" data-id="${id}" class="stockInput"></td>
      <td class="active-checkbox"><input type="checkbox" data-id="${id}" class="activeInput" ${p.active !== false ? 'checked' : ''}></td>
      <td>
        <img src="${p.image ? p.image : `https://pedrorabc09-design.github.io/catalogo-164/imagenes/no-image.png`}" class="preview">
        ${p.image ? '' : '<input type="file" data-id="'+id+'" class="imageInput">'}
      </td>
      <td><button data-id="${id}" class="saveBtn">Guardar</button></td>
    `;
    table.appendChild(tr);
  });
  bindEvents();
});

function bindEvents() {
  document.querySelectorAll(".saveBtn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const name = document.querySelector(`.nameInput[data-id="${id}"]`).value;
      const code = document.querySelector(`.codeInput[data-id="${id}"]`).value;
      const category = document.querySelector(`.categoryInput[data-id="${id}"]`).value;
      const price = parseFloat(document.querySelector(`.priceInput[data-id="${id}"]`).value) || 0;
      const discountPrice = parseFloat(document.querySelector(`.discountPriceInput[data-id="${id}"]`).value) || price;
      const stock = parseInt(document.querySelector(`.stockInput[data-id="${id}"]`).value) || 0;
      const active = document.querySelector(`.activeInput[data-id="${id}"]`).checked;

      let imageUrl = document.querySelector(`img.preview`).src;

      // Solo subir imagen si input existe (nuevo producto)
      const imageInput = document.querySelector(`.imageInput[data-id="${id}"]`);
      if (imageInput && imageInput.files.length > 0) {
        const file = imageInput.files[0];
        const storageRef = sRef(storage, `products/${id}/${file.name}`);
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }

      await updateDoc(doc(db, "products", id), {
        name, code, category, price, discountPrice, stock, active, image: imageUrl
      });

      alert("âœ… Producto actualizado");
    };
  });
}

// Crear producto nuevo
async function createProduct() {
  const newDoc = await addDoc(collection(db, "products"), {
    name: "Nuevo Producto",
    code: "ID"+Date.now(),
    category: "CategorÃ­a",
    price: 0,
    discountPrice: 0,
    stock: 0,
    active: true,
    image: ""
  });
  alert("Producto creado âœ…");
}

</script>
</body>
</html>
