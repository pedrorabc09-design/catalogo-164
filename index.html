<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catálogo 1/64</title>

<style>
/* ===================== PARCHE VISUAL ===================== */
.slider-arrow {
  display: none;
}

.card-track.no-scroll {
  overflow: hidden !important;
}

.badge-last {
  position: absolute;
  top: 8px;
  left: 8px;
  background: #ff9800;
  color: #000;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 6px;
  font-weight: bold;
}

.badge-out {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #f44336;
  color: #fff;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 6px;
  font-weight: bold;
}

/* ========================================================= */
</style>
</head>

<body>

<!-- ===================== CONTENIDO EXISTENTE ===================== -->
<!-- TU CABECERA, LOGO, BUSCADOR, ICONOS, ETC (NO TOCADO) -->

<!-- ===================== SLIDER DE PRODUCTOS ===================== -->
<div class="slider-container">
  <button class="slider-arrow left" onclick="slideLeft(this)">‹</button>
  <div class="card-track"></div>
  <button class="slider-arrow right" onclick="slideRight(this)">›</button>
</div>

<!-- ===================== JS ===================== -->
<script>
/* =========================================================
   PARCHE 1: RESERVA DE STOCK (20 MIN)
========================================================= */

const RESERVE_TIME = 20 * 60 * 1000;

function cleanExpiredReservations() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const now = Date.now();

  const valid = cart.filter(item => {
    return now - item.reservedAt < RESERVE_TIME;
  });

  if (valid.length !== cart.length) {
    localStorage.setItem("cart", JSON.stringify(valid));
  }
}

cleanExpiredReservations();

/* =========================================================
   PARCHE 2: STOCK DISPONIBLE REAL
========================================================= */

function getReservedQty(productName) {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const now = Date.now();

  return cart.reduce((sum, item) => {
    if (item.name === productName && now - item.reservedAt < RESERVE_TIME) {
      return sum + item.qty;
    }
    return sum;
  }, 0);
}

/* =========================================================
   PARCHE 3: RENDER DE CARD (SIN CAMBIAR ESTRUCTURA)
========================================================= */

function renderCard(product, container) {
  const reserved = getReservedQty(product.name);
  const available = product.stock - reserved;

  const card = document.createElement("div");
  card.className = "card";
  card.style.position = "relative";

  if (available <= 0) {
    const out = document.createElement("div");
    out.className = "badge-out";
    out.textContent = "Agotado";
    card.appendChild(out);
  }

  if (available === 1) {
    const last = document.createElement("div");
    last.className = "badge-last";
    last.textContent = "Última unidad";
    card.appendChild(last);
  }

  card.innerHTML += `
    <img src="${product.image}">
    <h4>${product.name}</h4>
    <p>S/ ${product.finalPrice || product.price}</p>
    <p>Stock: ${Math.max(available, 0)}</p>
    <button ${available <= 0 ? "disabled" : ""} onclick="addToCart('${product.name}', ${product.finalPrice || product.price}, ${available})">
      Añadir
    </button>
  `;

  container.appendChild(card);
}

/* =========================================================
   PARCHE 4: AÑADIR AL CARRITO (VALIDA STOCK)
========================================================= */

function addToCart(name, price, available) {
  if (available <= 0) return;

  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const item = cart.find(i => i.name === name);

  if (item) {
    if (item.qty + 1 > available) return;
    item.qty++;
    item.reservedAt = Date.now();
  } else {
    cart.push({
      name,
      price,
      qty: 1,
      reservedAt: Date.now()
    });
  }

  localStorage.setItem("cart", JSON.stringify(cart));
  render(); // ya existe en tu código
}

/* =========================================================
   PARCHE 5: FLECHAS SOLO SI HAY OVERFLOW
========================================================= */

function updateArrows(slider) {
  const track = slider.querySelector(".card-track");
  const left = slider.querySelector(".slider-arrow.left");
  const right = slider.querySelector(".slider-arrow.right");

  requestAnimationFrame(() => {
    const overflow = track.scrollWidth > track.clientWidth;

    if (!overflow) {
      left.style.display = "none";
      right.style.display = "none";
      track.classList.add("no-scroll");
      return;
    }

    track.classList.remove("no-scroll");
    left.style.display = track.scrollLeft > 0 ? "flex" : "none";
    right.style.display =
      track.scrollLeft + track.clientWidth < track.scrollWidth
        ? "flex"
        : "none";
  });
}

function slideRight(btn) {
  const slider = btn.closest(".slider-container");
  const track = slider.querySelector(".card-track");
  track.scrollBy({ left: 300, behavior: "smooth" });
  setTimeout(() => updateArrows(slider), 300);
}

function slideLeft(btn) {
  const slider = btn.closest(".slider-container");
  const track = slider.querySelector(".card-track");
  track.scrollBy({ left: -300, behavior: "smooth" });
  setTimeout(() => updateArrows(slider), 300);
}

/* =========================================================
   PARCHE 6: INTEGRACIÓN CON TU RENDER EXISTENTE
========================================================= */

const originalRender = render;
render = function () {
  cleanExpiredReservations();
  originalRender();

  document.querySelectorAll(".slider-container").forEach(updateArrows);
};

</script>

</body>
</html>
